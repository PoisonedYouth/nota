<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
    <!-- Einzelne Notiz-Karte -->
    <div th:fragment="note-card(note)"
         th:class="|note-card ${note?.isOverdue() ? 'note-overdue' : ''} ${note?.isDueSoon() ? 'note-due-soon' : ''}|"
         th:id="|note-${note != null ? note.id : ''}|">
        <h3 class="note-title">
            <a th:href="@{/notes/{id}(id=${note != null ? note.id : ''})}"
               th:text="${note?.title}"
               class="note-title-link"></a>
        </h3>
        <p class="note-content" th:text="${note?.getContentPreview()}"></p>
        <div class="note-meta">
            <span class="note-date" th:text="${note?.getFormattedDate()}"></span>
            <span th:if="${note?.dueDate != null}" class="note-due-date" th:text="|Fällig: ${note?.getFormattedDueDate()}|"></span>
            <span class="note-owner" th:text="|Ersteller: ${note?.user?.username}|"></span>
            <div th:if="${!note?.archived}" class="note-actions">
                <button class="btn btn-primary btn-sm"
                        th:attr="hx-get=@{/notes/modal/{id}(id=${note != null ? note.id : ''})}"
                        hx-target="#modal-container">
                    Bearbeiten
                </button>
                <button class="btn btn-info btn-sm"
                        th:attr="hx-get=@{/notes/modal/{id}(id=${note != null ? note.id : ''}, mode='share')}"
                        hx-target="#modal-container">
                    Teilen
                </button>
                <button class="btn btn-danger btn-sm"
                        th:attr="hx-delete=@{/notes/{id}(id=${note != null ? note.id : ''})}"
                        hx-confirm="Notiz archivieren?"
                        hx-target="closest .note-card"
                        hx-swap="outerHTML swap:0.5s">
                    Archivieren
                </button>
            </div>
        </div>
    </div>

    <!-- Common note form fragment -->
    <div th:fragment="note-form(formAction, formMethod, formTarget, formSwap, formTrigger, formOnAfterRequest, note, submitButtonText)">
        <form th:attr="hx-post=${formMethod == 'POST' ? formAction : null},
                       hx-put=${formMethod == 'PUT' ? formAction : null},
                       hx-target=${formTarget},
                       hx-swap=${formSwap},
                       hx-trigger=${formTrigger},
                       hx-on=${formOnAfterRequest}">

            <div class="form-group">
                <label for="title">Titel</label>
                <input type="text"
                       id="title"
                       name="title"
                       class="form-control"
                       placeholder="Notiz-Titel eingeben..."
                       th:value="${note?.title}"
                       required
                       autofocus>
            </div>

            <div class="form-group">
                <label for="content">Inhalt</label>
                <textarea id="content"
                          name="content"
                          class="form-control"
                          rows="10"
                          placeholder="Notiz-Inhalt eingeben..."
                          th:text="${note?.content}"
                          required></textarea>
            </div>

            <div class="form-group">
                <label for="dueDate">Fälligkeitsdatum</label>
                <input type="datetime-local"
                       id="dueDate"
                       name="dueDate"
                       class="form-control"
                       th:value="${note?.dueDate != null ? #temporals.format(note.dueDate, 'yyyy-MM-dd''T''HH:mm') : ''}">
            </div>

            <input type="hidden" name="id" th:value="${note != null ? note.id : ''}" th:if="${note != null and note.id != null}">

            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary cancel-modal-btn"
                        onclick="document.getElementById('unified-note-modal').remove()">
                    Abbrechen
                </button>
                <button type="submit" class="btn btn-primary">
                    <span class="htmx-indicator">
                        Speichern...
                    </span>
                    <span class="htmx-indicator-hide" th:text="${submitButtonText}">
                        Speichern
                    </span>
                </button>
            </div>
        </form>
    </div>

    <!-- Archive response fragment that removes note card and updates count -->
    <div th:fragment="archive-response">
        <!-- Empty content to remove the note card -->

        <!-- Out-of-band swap to update notes count -->
        <div class="notes-count"
             th:text="|${#lists.size(notes)} Notizen|"
             hx-swap-oob="true"></div>
    </div>
</body>
</html>
