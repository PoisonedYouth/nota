<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
    <!-- Individual note card -->
    <div th:fragment="note-card(note)"
         th:class="|note-card ${note?.isOverdue() ? 'note-overdue' : ''} ${note?.isDueSoon() ? 'note-due-soon' : ''}|"
         th:id="|note-${note != null ? note.id : ''}|">
        <h3 class="note-title">
            <a th:href="@{/notes/{id}(id=${note != null ? note.id : ''})}"
               th:text="${note?.title}"
               class="note-title-link"></a>
        </h3>

        <!-- Note metadata -->
        <div class="note-meta">
            <div class="note-meta-info">
                <span class="note-date" th:text="${note?.getFormattedDate()}"></span>
                <span th:if="${note?.dueDate != null}" class="note-due-date" th:text="|Due: ${note?.getFormattedDueDate()}|"></span>
                <span class="note-owner" th:text="|by ${note?.user?.username}|"></span>
            </div>
        </div>

        <!-- Note actions - separate from meta for better layout -->
        <div th:if="${!note?.archived}" class="note-actions">
            <button class="btn btn-secondary btn-sm"
                    th:attr="hx-get=@{/notes/modal/{id}(id=${note != null ? note.id : ''})}"
                    hx-target="#modal-container">
                <span>✏️</span> Edit
            </button>
            <button class="btn btn-secondary btn-sm"
                    th:attr="hx-get=@{/notes/modal/{id}(id=${note != null ? note.id : ''}, mode='share')}"
                    hx-target="#modal-container">
                <span>👥</span> Share
            </button>
            <button class="btn btn-accent btn-sm"
                    th:attr="hx-delete=@{/notes/{id}(id=${note != null ? note.id : ''})}"
                    hx-confirm="Archive note?"
                    hx-target="closest .note-card"
                    hx-swap="outerHTML swap:0.5s">
                <span>📦</span> Archive
            </button>
        </div>
    </div>

    <!-- Common note form fragment -->
    <div th:fragment="note-form(formAction, formMethod, formTarget, formSwap, formTrigger, formOnAfterRequest, note, submitButtonText)">
        <form th:attr="hx-post=${formMethod == 'POST' ? formAction : null},
                       hx-put=${formMethod == 'PUT' ? formAction : null},
                       hx-target=${formTarget},
                       hx-swap=${formSwap},
                       hx-trigger=${formTrigger},
                       hx-on=${formOnAfterRequest}">

            <div class="form-group">
                <label for="title">Title</label>
                <input type="text"
                       id="title"
                       name="title"
                       class="form-control"
                       placeholder="Enter note title..."
                       th:value="${note?.title}"
                       required
                       autofocus>
            </div>

            <div class="form-group">
                <label for="content">Content</label>
                <div id="content-editor" style="height: 200px;"></div>
                <input type="hidden" id="content" name="content" th:value="${note?.content}" required>
            </div>

            <div class="form-group">
                <label for="dueDate">Due Date</label>
                <input type="datetime-local"
                       id="dueDate"
                       name="dueDate"
                       class="form-control"
                       th:value="${note?.dueDate != null ? #temporals.format(note.dueDate, 'yyyy-MM-dd''T''HH:mm') : ''}">
            </div>

            <!-- Attachment info for create/edit -->
            <div class="form-group attachment-info">
                <div th:if="${note == null}" class="note-info">
                    <p><strong>📎 Attachments:</strong> You can add file attachments after creating the note.</p>
                </div>
                <div th:if="${note != null}" class="note-info">
                    <p><strong>📎 Attachments:</strong> You can manage attachments from the <a th:href="@{/notes/{id}(id=${note.id})}" target="_blank">note detail page</a>.</p>
                </div>
            </div>

            <input type="hidden" name="id" th:value="${note != null ? note.id : ''}" th:if="${note != null and note.id != null}">

            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary cancel-modal-btn"
                        onclick="document.getElementById('unified-note-modal').remove()">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                    <span class="htmx-indicator">
                        Saving...
                    </span>
                    <span class="htmx-indicator-hide" th:text="${submitButtonText}">
                        Save
                    </span>
                </button>
            </div>
        </form>
    </div>

    <!-- Archive response fragment that removes note card and updates count -->
    <div th:fragment="archive-response">
        <!-- Empty content to remove the note card -->

        <!-- Out-of-band swap to update notes count -->
        <div class="notes-count"
             th:text="|${#lists.size(notes)} Notes|"
             hx-swap-oob="true"></div>
    </div>

    <!-- Attachments section -->
    <div th:fragment="attachments-section" class="attachments-section" id="attachments-section">
        <div class="section-header">
            <h3>Attachments</h3>
            <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
            <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>
        </div>

        <!-- File upload form (only for note owners) -->
        <div th:if="${note != null and !note.archived}" class="attachment-upload-form">
            <form th:hx-post="@{/notes/{id}/attachments(id=${note.id})}"
                  hx-target="#attachments-section"
                  hx-swap="outerHTML"
                  enctype="multipart/form-data"
                  class="upload-form">
                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <div class="upload-group">
                    <input type="file"
                           id="attachment-file"
                           name="file"
                           class="file-input"
                           onchange="validateFileSize(this)"
                           required>
                    <button type="submit" class="btn btn-primary btn-sm">
                        <span>📎</span> Upload
                    </button>
                </div>
                <div class="file-info" style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
                    Maximum file size: 25MB
                </div>
            </form>
        </div>

        <!-- Attachments list -->
        <div th:if="${attachments != null and not #lists.isEmpty(attachments)}" class="attachments-list">
            <div th:each="attachment : ${attachments}" class="attachment-item">
                <div class="attachment-info">
                    <span class="attachment-icon">📄</span>
                    <div class="attachment-details">
                        <span class="attachment-name" th:text="${attachment.filename}"></span>
                        <span class="attachment-meta">
                            <span th:text="${#numbers.formatDecimal(attachment.fileSize / 1024.0, 1, 1)} + ' KB'"></span>
                            <span th:text="'• ' + ${#temporals.format(attachment.createdAt, 'MMM dd, yyyy')}"></span>
                        </span>
                    </div>
                </div>
                <div class="attachment-actions">
                    <a th:href="@{/notes/{id}/attachments/{attachmentId}/download(id=${note.id}, attachmentId=${attachment.id})}"
                       class="btn btn-secondary btn-sm"
                       title="Download">
                        <span>⬇️</span>
                    </a>
                    <button th:if="${note != null and !note.archived}"
                            class="btn btn-danger btn-sm"
                            th:hx-delete="@{/notes/{id}/attachments/{attachmentId}(id=${note.id}, attachmentId=${attachment.id})}"
                            hx-target="#attachments-section"
                            hx-swap="outerHTML"
                            hx-confirm="Are you sure you want to delete this attachment?"
                            title="Delete">
                        <span>🗑️</span>
                    </button>
                </div>
            </div>
        </div>

        <div th:if="${attachments == null or #lists.isEmpty(attachments)}" class="no-attachments">
            <p>No attachments</p>
        </div>
    </div>

    <!-- Error message fragment -->
    <div th:fragment="attachment-error" class="alert alert-error" th:if="${error}" th:text="${error}"></div>

    <!-- Note Activities Section -->
    <div th:fragment="note-activities-section" class="note-activities-section">
        <h4 class="section-title">Recent Note Activity</h4>

        <div th:if="${noteActivities != null and not #lists.isEmpty(noteActivities)}" class="note-activities-list">
            <div th:each="activity : ${noteActivities}" class="note-activity-item">
                <div class="activity-icon">
                    <span th:switch="${activity.action}">
                        <span th:case="'CREATE'">➕</span>
                        <span th:case="'UPDATE'">✏️</span>
                        <span th:case="'ARCHIVE'">📦</span>
                        <span th:case="'SHARE'">🔗</span>
                        <span th:case="'UPLOAD_ATTACHMENT'">📎</span>
                        <span th:case="'DOWNLOAD_ATTACHMENT'">⬇️</span>
                        <span th:case="'DELETE_ATTACHMENT'">🗑️</span>
                        <span th:case="*">📝</span>
                    </span>
                </div>
                <div class="activity-content">
                    <div class="activity-description" th:text="${activity.description}"></div>
                    <div class="activity-time" th:text="${activity.formattedCreatedAt}"></div>
                </div>
            </div>
        </div>

        <div th:if="${noteActivities == null or #lists.isEmpty(noteActivities)}" class="no-activities">
            <p>No recent activity for this note</p>
        </div>
    </div>

    <script>
        function validateFileSize(input) {
            const maxSizeInBytes = 25 * 1024 * 1024; // 25MB
            const file = input.files[0];

            if (file && file.size > maxSizeInBytes) {
                alert('File too large! Maximum file size is 25MB.');
                input.value = ''; // Clear the input
                return false;
            }
            return true;
        }
    </script>
</body>
</html>
