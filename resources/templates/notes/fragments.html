<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
    <!-- Einzelne Notiz-Karte -->
    <div th:fragment="note-card(note)"
         th:class="|note-card ${note?.isOverdue() ? 'note-overdue' : ''} ${note?.isDueSoon() ? 'note-due-soon' : ''}|"
         th:id="|note-${note != null ? note.id : ''}|">
        <h3 class="note-title">
            <a th:href="@{/notes/{id}(id=${note != null ? note.id : ''})}"
               th:text="${note?.title}"
               class="note-title-link"></a>
        </h3>
        
        <!-- Note metadata -->
        <div class="note-meta">
            <div class="note-meta-info">
                <span class="note-date" th:text="${note?.getFormattedDate()}"></span>
                <span th:if="${note?.dueDate != null}" class="note-due-date" th:text="|F√§llig: ${note?.getFormattedDueDate()}|"></span>
                <span class="note-owner" th:text="|von ${note?.user?.username}|"></span>
            </div>
        </div>
        
        <!-- Note actions - separate from meta for better layout -->
        <div th:if="${!note?.archived}" class="note-actions">
            <button class="btn btn-secondary btn-sm"
                    th:attr="hx-get=@{/notes/modal/{id}(id=${note != null ? note.id : ''})}"
                    hx-target="#modal-container">
                <span>‚úèÔ∏è</span> Bearbeiten
            </button>
            <button class="btn btn-secondary btn-sm"
                    th:attr="hx-get=@{/notes/modal/{id}(id=${note != null ? note.id : ''}, mode='share')}"
                    hx-target="#modal-container">
                <span>üë•</span> Teilen
            </button>
            <button class="btn btn-accent btn-sm"
                    th:attr="hx-delete=@{/notes/{id}(id=${note != null ? note.id : ''})}"
                    hx-confirm="Notiz archivieren?"
                    hx-target="closest .note-card"
                    hx-swap="outerHTML swap:0.5s">
                <span>üì¶</span> Archivieren
            </button>
        </div>
    </div>

    <!-- Common note form fragment -->
    <div th:fragment="note-form(formAction, formMethod, formTarget, formSwap, formTrigger, formOnAfterRequest, note, submitButtonText)">
        <form th:attr="hx-post=${formMethod == 'POST' ? formAction : null},
                       hx-put=${formMethod == 'PUT' ? formAction : null},
                       hx-target=${formTarget},
                       hx-swap=${formSwap},
                       hx-trigger=${formTrigger},
                       hx-on=${formOnAfterRequest}">

            <div class="form-group">
                <label for="title">Titel</label>
                <input type="text"
                       id="title"
                       name="title"
                       class="form-control"
                       placeholder="Notiz-Titel eingeben..."
                       th:value="${note?.title}"
                       required
                       autofocus>
            </div>

            <div class="form-group">
                <label for="content">Inhalt</label>
                <div id="content-editor" style="height: 200px;"></div>
                <input type="hidden" id="content" name="content" th:value="${note?.content}" required>
            </div>

            <div class="form-group">
                <label for="dueDate">F√§lligkeitsdatum</label>
                <input type="datetime-local"
                       id="dueDate"
                       name="dueDate"
                       class="form-control"
                       th:value="${note?.dueDate != null ? #temporals.format(note.dueDate, 'yyyy-MM-dd''T''HH:mm') : ''}">
            </div>

            <input type="hidden" name="id" th:value="${note != null ? note.id : ''}" th:if="${note != null and note.id != null}">

            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary cancel-modal-btn"
                        onclick="document.getElementById('unified-note-modal').remove()">
                    Abbrechen
                </button>
                <button type="submit" class="btn btn-primary">
                    <span class="htmx-indicator">
                        Speichern...
                    </span>
                    <span class="htmx-indicator-hide" th:text="${submitButtonText}">
                        Speichern
                    </span>
                </button>
            </div>
        </form>

        <script>
            // Initialize Quill editor when the fragment is loaded
            document.addEventListener('DOMContentLoaded', function() {
                initializeQuillEditor();
            });

            // Also initialize when HTMX loads the fragment
            document.addEventListener('htmx:afterSettle', function(event) {
                if (event.target.querySelector('#content-editor')) {
                    initializeQuillEditor();
                }
            });

            function initializeQuillEditor() {
                const editorElement = document.getElementById('content-editor');
                const hiddenInput = document.getElementById('content');

                if (!editorElement || editorElement.classList.contains('ql-container')) {
                    return; // Already initialized
                }

                // Initialize Quill
                const quill = new Quill('#content-editor', {
                    theme: 'snow',
                    placeholder: 'Notiz-Inhalt eingeben...',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, false] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            ['blockquote', 'code-block'],
                            ['link'],
                            ['clean']
                        ]
                    }
                });

                // Set initial content if available
                if (hiddenInput.value) {
                    quill.root.innerHTML = hiddenInput.value;
                }

                // Update hidden input when content changes
                quill.on('text-change', function() {
                    hiddenInput.value = quill.root.innerHTML;
                });

                // Ensure content is updated before form submission
                const form = editorElement.closest('form');
                if (form) {
                    form.addEventListener('submit', function() {
                        hiddenInput.value = quill.root.innerHTML;
                    });
                }
            }
        </script>
    </div>

    <!-- Archive response fragment that removes note card and updates count -->
    <div th:fragment="archive-response">
        <!-- Empty content to remove the note card -->

        <!-- Out-of-band swap to update notes count -->
        <div class="notes-count"
             th:text="|${#lists.size(notes)} Notizen|"
             hx-swap-oob="true"></div>
    </div>
</body>
</html>
