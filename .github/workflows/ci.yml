name: CI/CD Pipeline

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]
  workflow_dispatch:

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'corretto'

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: ${{ env.JAVA_DISTRIBUTION }}

    - name: Cache Amper dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.m2
          ~/.gradle/caches
          ~/.gradle/wrapper
          .amper/cache
        key: ${{ runner.os }}-amper-${{ hashFiles('**/module.yaml') }}
        restore-keys: |
          ${{ runner.os }}-amper-

    - name: Make Amper executable
      run: chmod +x ./amper

    - name: Build project
      run: ./amper build

    - name: Run tests
      run: ./amper test

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          build/reports/**/*.xml
          build/logs/amper_*_test/
        retention-days: 30

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: ${{ env.JAVA_DISTRIBUTION }}

    - name: Cache tools
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/ktlint
          tools/
        key: ${{ runner.os }}-tools-${{ hashFiles('tools/**') }}
        restore-keys: |
          ${{ runner.os }}-tools-

    - name: Install ktlint
      run: |
        if [ ! -f /usr/local/bin/ktlint ]; then
          curl -sSLO https://github.com/pinterest/ktlint/releases/download/1.6.0/ktlint
          chmod +x ktlint
          sudo mv ktlint /usr/local/bin/
        fi

    - name: Install detekt
      run: |
        if [ ! -f tools/detekt-cli-1.23.8-all.jar ]; then
          mkdir -p tools
          cd tools
          curl -sSLO https://github.com/detekt/detekt/releases/download/v1.23.8/detekt-cli-1.23.8-all.jar
          chmod +x detekt-cli-1.23.8-all.jar
          cd -
        fi

    - name: Run ktlint
      run: |
        echo "Running ktlint style checks..."
        ktlint --reporter=checkstyle,output=build/reports/ktlint-checkstyle.xml --color --reporter=plain "src/**/*.kt" "test/**/*.kt"

    - name: Run detekt
      run: |
        echo "Running detekt static analysis..."
        java -jar tools/detekt-cli-1.23.8-all.jar \
          --config tools/default-detekt-config.yml \
          --input src/ \
          --report xml:build/reports/detekt.xml \
          --report txt:build/reports/detekt.txt

    - name: Upload code quality reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: code-quality-reports
        path: |
          build/reports/ktlint-checkstyle.xml
          build/reports/detekt.xml
          build/reports/detekt.txt
        retention-days: 30

  build-jar:
    name: Build JAR
    runs-on: ubuntu-latest
    needs: [test, code-quality]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: ${{ env.JAVA_DISTRIBUTION }}

    - name: Cache Amper dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.m2
          ~/.gradle/caches
          ~/.gradle/wrapper
          .amper/cache
        key: ${{ runner.os }}-amper-${{ hashFiles('**/module.yaml') }}
        restore-keys: |
          ${{ runner.os }}-amper-

    - name: Make Amper executable
      run: chmod +x ./amper

    - name: Build application
      run: ./amper build

    - name: Create application JAR
      run: |
        # Find the built JAR file
        JAR_PATH=$(find build -name "*.jar" -type f | grep -v sources | head -1)
        if [ -z "$JAR_PATH" ]; then
          echo "No JAR file found in build directory"
          ls -la build/
          exit 1
        fi

        # Copy to a standard location with version info
        VERSION=$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA::7}
        cp "$JAR_PATH" "nota-${VERSION}.jar"
        cp "$JAR_PATH" "nota-latest.jar"

        echo "JAR_VERSION=${VERSION}" >> $GITHUB_ENV
        echo "JAR_PATH=${JAR_PATH}" >> $GITHUB_ENV

    - name: Verify JAR
      run: |
        echo "JAR file information:"
        ls -la nota-*.jar
        echo "JAR manifest:"
        jar -tf nota-latest.jar | head -20

    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: nota-jar-${{ env.JAR_VERSION }}
        path: |
          nota-${{ env.JAR_VERSION }}.jar
          nota-latest.jar
        retention-days: 90

    - name: Upload JAR as release asset (on main branch)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: actions/upload-artifact@v4
      with:
        name: nota-release-jar
        path: nota-latest.jar
        retention-days: 365

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [build-jar]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: ${{ env.JAVA_DISTRIBUTION }}

    - name: Cache Amper dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.m2
          ~/.gradle/caches
          ~/.gradle/wrapper
          .amper/cache
        key: ${{ runner.os }}-amper-${{ hashFiles('**/module.yaml') }}
        restore-keys: |
          ${{ runner.os }}-amper-

    - name: Make Amper executable
      run: chmod +x ./amper

    - name: Build for security scanning
      run: ./amper build

    - name: Run dependency vulnerability scan
      run: |
        echo "Scanning for vulnerable dependencies..."
        # This will scan dependencies for known vulnerabilities
        # Note: Amper might need specific commands for this, adapting to use basic checks
        if command -v dependency-check &> /dev/null; then
          dependency-check --project "Nota" --scan . --format ALL --out ./dependency-check-report
        else
          echo "dependency-check not available, skipping vulnerability scan"
          mkdir -p ./dependency-check-report
          echo "Vulnerability scan skipped - dependency-check not installed" > ./dependency-check-report/scan-skipped.txt
        fi

    - name: Upload security scan results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan-results
        path: |
          dependency-check-report/
        retention-days: 30

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build-jar]

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: nota_test
          POSTGRES_USER: nota
          POSTGRES_PASSWORD: nota_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: ${{ env.JAVA_DISTRIBUTION }}

    - name: Cache Amper dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.m2
          ~/.gradle/caches
          ~/.gradle/wrapper
          .amper/cache
        key: ${{ runner.os }}-amper-${{ hashFiles('**/module.yaml') }}
        restore-keys: |
          ${{ runner.os }}-amper-

    - name: Make Amper executable
      run: chmod +x ./amper

    - name: Run integration tests
      env:
        SPRING_PROFILES_ACTIVE: test
        SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/nota_test
        SPRING_DATASOURCE_USERNAME: nota
        SPRING_DATASOURCE_PASSWORD: nota_password
      run: |
        echo "Running integration tests with PostgreSQL..."
        ./amper test --include-classes="*IntegrationTest*,*E2ETest*"

    - name: Upload integration test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: |
          build/reports/**/*.xml
          build/logs/amper_*_test/
        retention-days: 30

  report:
    name: Generate Report
    runs-on: ubuntu-latest
    needs: [test, code-quality, build-jar, security-scan, integration-test]
    if: always()

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Generate build summary
      run: |
        echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Test results
        if [ -d "artifacts/test-results" ]; then
          echo "âœ… **Unit Tests**: Completed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Unit Tests**: Failed" >> $GITHUB_STEP_SUMMARY
        fi

        # Code quality
        if [ -d "artifacts/code-quality-reports" ]; then
          echo "âœ… **Code Quality**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Code Quality**: Failed" >> $GITHUB_STEP_SUMMARY
        fi

        # JAR build
        if [ -d "artifacts/nota-jar-"* ]; then
          JAR_DIR=$(ls artifacts/ | grep "nota-jar-" | head -1)
          JAR_VERSION=${JAR_DIR#nota-jar-}
          echo "âœ… **JAR Build**: Completed (Version: ${JAR_VERSION})" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **JAR Build**: Failed" >> $GITHUB_STEP_SUMMARY
        fi

        # Integration tests
        if [ -d "artifacts/integration-test-results" ]; then
          echo "âœ… **Integration Tests**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Integration Tests**: Failed" >> $GITHUB_STEP_SUMMARY
        fi

        # Security scan
        if [ -d "artifacts/security-scan-results" ]; then
          echo "âœ… **Security Scan**: Completed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Security Scan**: Skipped or Failed" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Build Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Java Version**: ${{ env.JAVA_VERSION }}" >> $GITHUB_STEP_SUMMARY

        if [ -d "artifacts/nota-jar-"* ]; then
          echo "- **JAR Size**: $(du -h artifacts/*/nota-latest.jar | cut -f1)" >> $GITHUB_STEP_SUMMARY
        fi
